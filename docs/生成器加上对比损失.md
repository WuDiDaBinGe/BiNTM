### 7.20号新方法—在Generator中`加入对比Loss

**Time：**2021-07-20-22-58

**Log：**checkpoint_2021-07-20-22-58_20news_clean_20

**Method**：参考CVPR2021的Text-Image论文以及ContraGAN的思路加入了Generator的Contrastive Loss具体方法如下：

![](https://gitee.com/yxbLovewy/my-pictures/raw/master/discrimitor.png)

![image-20210721105021800](https://gitee.com/yxbLovewy/my-pictures/raw/master/mdimgs/image-20210721105021800.png)

超参数设置如下：

| batch size | clip | learning rate | beta_1 | beta_2 | n_critic | optimizer | temperature |
| :--------: | :--: | :-----------: | :----: | :----: | :------: | :-------: | :---------: |
|    256     | 0.01 |     1e-4      |  0.5   | 0.999  |    5     |   Adam    |    0.07     |

曲线图：

|                           评价指标                           |                           Loss曲线                           | 对比Loss                                                     |
| :----------------------------------------------------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
| ![image-20210722211234733](/home/yxb/.config/Typora/typora-user-images/image-20210722211234733.png) | ![image-20210722211259462](/home/yxb/.config/Typora/typora-user-images/image-20210722211259462.png) | ![image-20210722211310323](/home/yxb/.config/Typora/typora-user-images/image-20210722211310323.png) |
| ![image-20210721105303104](https://gitee.com/yxbLovewy/my-pictures/raw/master/mdimgs/image-20210721105303104.png) | ![image-20210721105246141](https://gitee.com/yxbLovewy/my-pictures/raw/master/mdimgs/image-20210721105246141.png) | ![image-20210721105316642](https://gitee.com/yxbLovewy/my-pictures/raw/master/mdimgs/image-20210721105316642.png) |

从训练情况看这种方法可以不怎么降低损失，最好的效果也达到了**0.053**左右。



**Time：**2021-07-22-22-18

**Log：**log/gc_atm/20news_clean_2021-07-22-22-18_topic20

**Method**：并且**单独设置了Generator的学习率为：lr/100**，**改变了temperature为0.1**

**改变超参数如下：**

| batch size | clip | learning rate | beta_1 | beta_2 | n_critic | optimizer | temperature |
| :--------: | :--: | :-----------: | :----: | :----: | :------: | :-------: | :---------: |
|    256     | 0.01 |     1e-4      |  0.5   | 0.999  |    5     |   Adam    |   **0.1**   |

|                           评价指标                           |                           Loss曲线                           | 对比Loss                                                     |
| :----------------------------------------------------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
| ![image-20210723143011134](/home/yxb/.config/Typora/typora-user-images/image-20210723143011134.png) | ![image-20210723143051474](/home/yxb/.config/Typora/typora-user-images/image-20210723143051474.png) | ![image-20210723143042676](/home/yxb/.config/Typora/typora-user-images/image-20210723143042676.png) |
| ![image-20210721105303104](/home/yxb/.config/Typora/typora-user-images/image-20210723143025014.png) | ![image-20210721105246141](/home/yxb/.config/Typora/typora-user-images/image-20210723143101362.png) | ![image-20210721105316642](https://gitee.com/yxbLovewy/my-pictures/raw/master/mdimgs/image-20210721105316642.png) |

效果不错，指标的最好的地方达到了**0.071**

```shell
['car', 'anyone', 'bike', 'new', 'good', 'buy', 'engine', 'oil', 'ride', 'dod']
['game', 'player', 'team', 'play', 'go', 'hockey', 'win', 'nhl', 'score', 'season']
['msg', 'doctor', 'food', 'patient', 'gordon', 'bank', 'disease', 'go', 'treatment', 'surrender']
['window', 'thanks', 'anyone', 'advance', 'display', 'color', 'screen', 'run', 'look', 'appreciate']
['card', 'monitor', 'video', 'mode', 'driver', 'vga', 'color', 'mouse', 'chip', 'speed']
['israel', 'israeli', 'arab', 'jews', 'bank', 'arabs', 'lebanese', 'gordon', 'lebanon', 'research']
['space', 'car', 'launch', 'cost', 'nasa', 'orbit', 'moon', 'shuttle', 'price', 'look']
['article', 'write', 'jewish', 'book', 'anyone', 'michael', 'know', 'name', 'christian', 'read']
['people', 'clinton', 'tax', 'government', 'think', 'go', 'get', 'want', 'batf', 'much']
['god', 'atheist', 'believe', 'people', 'say', 'atheism', 'exist', 'think', 'belief', 'faith']
['turkish', 'armenian', 'armenians', 'armenia', 'turks', 'turkey', 'government', 'law', 'genocide', 'war']
['windows', 'file', 'driver', 'dos', 'font', 'version', 'use', 'program', 'window', 'problem']
['game', 'win', 'year', 'team', 'run', 'hit', 'season', 'last', 'baseball', 'pitch']
['thanks', 'please', 'post', 'file', 'anyone', 'mail', 'email', 'list', 'advance', 'send']
['go', 'car', 'get', 'think', 'bike', 'right', 'back', 'say', 'ride', 'like']
['god', 'jesus', 'christian', 'bible', 'christ', 'sin', 'believe', 'faith', 'say', 'church']
['gun', 'weapon', 'people', 'firearm', 'crime', 'kill', 'criminal', 'death', 'radar', 'amendment']
['drive', 'disk', 'scsi', 'controller', 'ide', 'mac', 'floppy', 'hard', 'modem', 'driver']
['key', 'chip', 'encryption', 'clipper', 'escrow', 'use', 'phone', 'government', 'system', 'algorithm']
['sale', 'offer', 'price', 'sell', 'card', 'condition', 'please', 'shipping', 'buy', 'email']
c_a:0.23019318905854483,c_p:0.3121698165762986, npmi:0.07203471161176403
```

***

**超参数不变，Topic=30的实验结果**

**Time：**2021-07-23-22-28

**Log：**log/gc_atm/20news_clean_2021-07-23-22-28_topic30

|                           评价指标                           |                           Loss曲线                           | 对比Loss                                                     |
| :----------------------------------------------------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
| ![image-20210724111225297](/home/yxb/.config/Typora/typora-user-images/image-20210724111225297.png) | ![image-20210724111246981](/home/yxb/.config/Typora/typora-user-images/image-20210724111246981.png) | ![image-20210724111324656](/home/yxb/.config/Typora/typora-user-images/image-20210724111324656.png) |
| ![image-20210724111357482](/home/yxb/.config/Typora/typora-user-images/image-20210724111357482.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210721105316642](https://gitee.com/yxbLovewy/my-pictures/raw/master/mdimgs/image-20210721105316642.png) |

![image-20210813035241979](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210813035241979.png)

---



**超参数不变，Topic=50的实验结果**

**Time：**2021-07-24-11-17

**Log：**log/gc_atm/20news_clean_2021-07-24-11-17_topic50

|                           评价指标                           |                           Loss曲线                           | 对比Loss                                                     |
| :----------------------------------------------------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
| ![image-20210725092602841](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210725092602841.png) | ![image-20210725092847551](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210725092847551.png) | ![image-20210725092626654](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210725092626654.png) |
| ![image-20210724111357482](/home/yxb/.config/Typora/typora-user-images/image-20210724111357482.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210721105316642](https://gitee.com/yxbLovewy/my-pictures/raw/master/mdimgs/image-20210721105316642.png) |

![image-20210813035416618](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210813035416618.png)

NPMI值统计：

|   20    |   30    |   50    |   75    |  100   |
| :-----: | :-----: | :-----: | :-----: | :----: |
| 0.07203 | 0.06853 | 0.04457 | 0.03741 | 0.0265 |

**temperature:** 设置较大的值，更容易分开

------

**超参数改变**

**Time：**2021-08-01-15-40

**Log：**20news_clean_2021-08-01-15-40_topic50

**Method:**generator的学习率lr/10

| batch size | clip | learning rate | beta_1 | beta_2 | n_critic | optimizer | temperature |
| :--------: | :--: | :-----------: | :----: | :----: | :------: | :-------: | :---------: |
|    256     | 0.01 |     1e-4      |  0.5   | 0.999  |    5     |   Adam    |   **0.5**   |

**Topic Num=50的时候效果如下**

|                           评价指标                           |                           Loss曲线                           | 对比Loss                                                     |
| :----------------------------------------------------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
| ![image-20210801214031198](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214031198.png) | ![image-20210801214043495](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214043495.png) | ![image-20210801214051086](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214051086.png) |
| ![image-20210724111357482](/home/yxb/.config/Typora/typora-user-images/image-20210724111357482.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**Log:**2021-08-03-16-52

调整温度参数$/gamma=0.5$​：

**max_value:0.04911**

***

topic_num=100, **max_value = 0.03307**

topic_num = 

***

### 使用**2C Loss**代替InfoNCE Loss generator的学习率**lr/10**

---

**Time：**2021-08-10-10-13

**Log：**20news_clean_2021-08-10-10-13_topic20

**Method:**generator的学习率**lr/10**

**Topic Num=20的时候效果如下**

|                           评价指标                           |                           Loss曲线                           |                           对比Loss                           |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![image-20210810142845693](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810142845693.png) | ![image-20210810142902765](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810142902765.png) | ![image-20210810142913029](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810142913029.png) |
| ![image-20210810095910488](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810095910488.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**max_value:**00601400

![image-20210813033135723](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210813033135723.png)

---

**Time：**2021-08-10-15-04

**Log：**20news_clean_2021-08-10-15-04_topic30

**Method:**generator的学习率**lr/10**

**Topic Num=30的时候效果如下**

|                           评价指标                           |                           Loss曲线                           |                           对比Loss                           |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![image-20210811135741385](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210811135741385.png) | ![image-20210811135800920](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210811135800920.png) | ![image-20210811135814007](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210811135814007.png) |
| ![image-20210810095910488](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810095910488.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**max_value:**0.06172

![image-20210813033322817](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210813033322817.png)

---

**Time：**2021-08-10-22-04

**Log：**20news_clean_2021-08-10-22-04_topic50

**Method:**generator的学习率**lr/10**

**Topic Num=50的时候效果如下**

|                           评价指标                           |                           Loss曲线                           |                           对比Loss                           |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![image-20210811140111996](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210811140111996.png) | ![image-20210811140125973](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210811140125973.png) | ![image-20210811140140261](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210811140140261.png) |
| ![image-20210810095910488](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810095910488.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**max_value:**0.059125

![image-20210811140244070](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210811140244070.png)

---



**Time：**2021-08-07-23-17

**Log：**20news_clean_2021-08-07-23-17_topic75

**Method:**generator的学习率**lr/10**

超参数设置如下：

| batch size | clip | learning rate | beta_1 | beta_2 | n_critic | optimizer | temperature |
| :--------: | :--: | :-----------: | :----: | :----: | :------: | :-------: | :---------: |
|    256     | 0.01 |     1e-4      |  0.5   | 0.999  |    5     |   Adam    |   **0.5**   |

**Topic Num=75的时候效果如下**

|                           评价指标                           |                           Loss曲线                           | 对比Loss                                                     |
| :----------------------------------------------------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
| ![image-20210808183406212](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210808183406212.png) | ![image-20210808183426459](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210808183426459.png) | ![image-20210808183417937](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210808183417937.png) |
| ![image-20210724111357482](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210724111357482.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**max_value:**0.05388106666666668

![image-20210813033542369](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210813033542369.png)

****

**Time：**2021-08-09-23-42

**Log：**20news_clean_2021-08-09-23-42_topic100

**Method:**generator的学习率**lr/10**

**Topic Num=100的时候效果如下**

|                           评价指标                           |                           Loss曲线                           |                           对比Loss                           |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![image-20210810101648222](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810101648222.png) | ![image-20210810101702908](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810101702908.png) | ![image-20210810101723337](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810101723337.png) |
| ![image-20210810095910488](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810095910488.png) | ![image-20210724111341895](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**max_value:**0.0324976

![image-20210813033634339](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210813033634339.png)

---

### Generator的学习率为lr/100

**Time：**2021-08-08-18-37

**Log：**20news_clean_2021-08-08-18-37_topic20

**Method:**generator的学习率**lr/100**

**Topic Num=20的时候效果如下**

|                           评价指标                           |                           Loss曲线                           | 对比Loss                                                     |
| :----------------------------------------------------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
| ![image-20210809101014912](/home/yxb/.config/Typora/typora-user-images/image-20210809101014912.png) | ![image-20210809101034252](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210809101034252.png) | ![image-20210809101024694](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210809101024694.png) |
| ![image-20210724111357482](/home/yxb/.config/Typora/typora-user-images/image-20210724111357482.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**max_value:**0.0620154

****

**Time：**2021-08-09-10-12

**Log：**20news_clean_2021-08-09-10-12_topic30

**Method:**generator的学习率**lr/100**

**Topic Num=30的时候效果如下**

|                           评价指标                           |                           Loss曲线                           | 对比Loss                                                     |
| :----------------------------------------------------------: | :----------------------------------------------------------: | ------------------------------------------------------------ |
| ![image-20210809135842422](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210809135842422.png) | ![image-20210809135904456](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210809135904456.png) | ![image-20210809135857931](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210809135857931.png) |
| ![image-20210724111357482](/home/yxb/.config/Typora/typora-user-images/image-20210724111357482.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**max_value:**0.06757633333

****

**Time：**2021-08-09-14-00

**Log：**20news_clean_2021-08-09-14-00_topic50

**Method:**generator的学习率**lr/100**

**Topic Num=50的时候效果如下**

|                           评价指标                           |                           Loss曲线                           |                           对比Loss                           |
| :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| ![image-20210812202258334](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210812202258334.png) | ![image-20210812202339794](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210812202339794.png) | ![image-20210812202324892](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210812202324892.png) |
| ![image-20210810095910488](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210810095910488.png) | ![image-20210724111341895](/home/yxb/.config/Typora/typora-user-images/image-20210724111341895.png) | ![image-20210801214113503](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210801214113503.png) |

**max_value:**0.0405572

---

温度参数影响Topic=50： 

g的lr = lr/10

temperature=0.5 上面测试了 max = 0.059125

temperature=1 效果较差      max=0.04XX

temperature=0.1                   max =  0.0587852 log:./log/gc_atm/20news_clean_2021-08-11-18-23_topic50/

![image-20210811222334245](https://gitee.com/yxbLovewy/my-pictures/raw/master/image-20210811222334245.png)

---

修改以下模型结构

```
--taskname
20news_clean
--n_topic
20
--num_epochs
50000
--train
True
--language
en
--clean_data
True
--batch_size
256
--n_critic
10
```



```
    def __init__(self, n_topic, hid_features_dim, v_dim, pre_embedding):
        super(ContraMeanGenerator, self).__init__()
        self.topic_num = n_topic
        self.v_dim = v_dim
        self.emb_dim = pre_embedding.shape[1]
        assert pre_embedding.shape[0] == v_dim
        self.embedding = nn.EmbeddingBag(num_embeddings=n_topic, embedding_dim=self.emb_dim, mode='sum')
        self.word_embedding = nn.EmbeddingBag(num_embeddings=v_dim, embedding_dim=self.emb_dim,
                                              mode='sum')
        self.generator_fc1 = nn.Sequential(
            *block(n_topic, hid_features_dim),
            nn.Linear(hid_features_dim, v_dim)
        )
        self.softmax = nn.Softmax(dim=1)

    def forward(self, theta, inputs_embedding, inputs_word_embedding):
        topic_label = torch.argmax(theta, dim=1)
        topic_embedding = self.embedding(inputs_embedding, per_sample_weights=theta).squeeze(dim=0)
        # topic_embedding = self.generator_fc1(theta)
        bow_out = self.softmax(self.generator_fc1(theta))
        z_features = self.word_embedding(inputs_word_embedding, per_sample_weights=bow_out).squeeze(dim=0)
        return bow_out, topic_embedding, z_features, topic_label
```

**Topic Num=20:**

